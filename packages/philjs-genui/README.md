# @philjs/genui

Runtime AI-driven UI composition with A2UI (Agent-to-UI) protocol for PhilJS.

## Overview

`@philjs/genui` enables AI agents to dynamically generate and update user interfaces at runtime using a structured JSON protocol. It provides secure, sandboxed execution of AI-generated UI specifications with full type safety.

## Features

- **A2UI Protocol**: Structured JSON schema for LLM-generated UI specifications
- **Component Registry**: Type-safe registration and querying of UI components
- **Security Sandbox**: AST validation to prevent injection attacks
- **Runtime Hydration**: Convert A2UI messages to live DOM elements
- **Reactive Bindings**: Connect UI to signals and data sources
- **Built-in Components**: Pre-registered safe components for common use cases

## Installation

```bash
npm install @philjs/genui
# or
pnpm add @philjs/genui
```

## Quick Start

```typescript
import {
  createRegistry,
  registerBuiltins,
  createHydrator,
  createRenderMessage,
  useGenUI,
} from '@philjs/genui';

// Setup registry with built-in components
const registry = createRegistry();
registerBuiltins(registry);

// Create a hydrator
const hydrator = createHydrator(registry, {
  onAgentAction: (actionId, event) => {
    console.log('Action:', actionId, event);
  },
});

// Create a render message
const message = createRenderMessage(
  { type: 'stack', gap: '16px' },
  [
    { id: 'heading', type: 'Heading', props: { children: 'Welcome', level: 1 } },
    { id: 'text', type: 'Text', props: { children: 'Generated by AI' } },
    { id: 'btn', type: 'Button', props: { children: 'Click me', variant: 'primary' } },
  ]
);

// Hydrate to DOM
const container = document.getElementById('app')!;
const result = hydrator.hydrate(message, container);

if (result.success) {
  console.log('UI rendered successfully');
}
```

## A2UI Protocol

The A2UI (Agent-to-UI) protocol defines how AI agents communicate UI specifications:

### Message Types

```typescript
// Render - Create a complete UI tree
const renderMessage = createRenderMessage(
  { type: 'flex', direction: 'row' },
  [{ id: 'comp-1', type: 'Button', props: { children: 'Submit' } }],
  {
    bindings: [...],
    actions: [...],
  }
);

// Update - Modify existing components
const updateMessage = createUpdateMessage('comp-1', {
  props: { disabled: true },
  animation: { type: 'fade', duration: 200 },
});

// Action - User interactions sent to agent
const actionMessage = createActionMessage(
  'btn-click',
  { type: 'click', data: { timestamp: Date.now() } }
);
```

### Layout Types

```typescript
// Stack layout (vertical/horizontal)
{ type: 'stack', direction: 'column', gap: '16px', align: 'center' }

// Grid layout
{ type: 'grid', columns: 'repeat(3, 1fr)', gap: '8px' }

// Flex layout
{ type: 'flex', direction: 'row', justify: 'between', wrap: true }

// Flow layout (block)
{ type: 'flow' }

// Absolute positioning
{ type: 'absolute' }
```

### Component Definition

```typescript
interface A2UIComponent {
  id: string;              // Unique identifier
  type: string;            // Component type from registry
  props: Record<string, unknown>;
  children?: A2UIComponent[];
  className?: string;
  style?: Record<string, string | number>;
  when?: { expression: string; fallback?: A2UIComponent };
  each?: { source: string; item: string; key: string };
  a11y?: { role?: string; label?: string; ... };
}
```

## Component Registry

Register custom components for AI agents to use:

```typescript
import { createRegistry, type ComponentCapability, type ComponentRenderer } from '@philjs/genui';

const registry = createRegistry();

// Define component capability (for LLM context)
const capability: ComponentCapability = {
  type: 'UserCard',
  displayName: 'User Card',
  description: 'Displays user information in a card format',
  category: 'display',
  props: [
    { name: 'name', type: 'string', required: true, description: 'User name' },
    { name: 'avatar', type: 'string', description: 'Avatar URL' },
    { name: 'role', type: 'string', enum: ['admin', 'user', 'guest'] },
  ],
  slots: [{ name: 'actions', description: 'Action buttons' }],
  events: [{ name: 'onSelect', description: 'Fired when card is selected' }],
  tags: ['user', 'profile', 'card'],
};

// Define renderer
const renderer: ComponentRenderer = (component, context) => {
  const card = document.createElement('div');
  card.className = 'user-card';
  card.innerHTML = `
    <img src="${component.props.avatar || '/default-avatar.png'}" />
    <h3>${component.props.name}</h3>
    <span>${component.props.role || 'user'}</span>
  `;
  return card;
};

registry.register(capability, renderer);

// Generate manifest for LLM
const manifest = registry.generateManifest();
// Send manifest to AI agent for context
```

## Security Sandbox

The sandbox validates AI-generated UI to prevent injection attacks:

```typescript
import { createValidator, DEFAULT_SANDBOX_CONFIG } from '@philjs/genui';

// Create validator with custom config
const validator = createValidator({
  allowedComponents: ['Button', 'Text', 'Input', 'Box'],
  maxDepth: 5,
  maxComponents: 50,
  allowInlineStyles: true,
  allowCustomEvents: false,
  blockedNavigationPatterns: [/javascript:/i, /data:/i],
});

// Validate a message
const result = validator.validate(message);

if (!result.valid) {
  console.error('Validation errors:', result.errors);
}
```

### Default Security Rules

- **Forbidden patterns**: `javascript:`, `data:`, `<script>`, `eval()`, `Function()`, etc.
- **Blocked DOM access**: `document.*`, `window.*`, `globalThis.*`
- **Prototype pollution prevention**: `__proto__`, `constructor[]`, `prototype[]`
- **Component limits**: Max depth (10), max components (100), max bindings (50)

## Hooks

### useGenUI

Hook for AI-generated UI with agent integration:

```typescript
import { useGenUI, createMockAgent } from '@philjs/genui';

// Create mock agent for testing
const mockAgent = createMockAgent((prompt) => ({
  version: '1.0',
  type: 'render',
  payload: {
    type: 'render',
    layout: { type: 'stack' },
    components: [
      { id: 'response', type: 'Text', props: { children: `Response to: ${prompt}` } },
    ],
  },
}));

// Use the hook
const genui = useGenUI({
  agent: mockAgent,
  onAgentAction: (actionId, event) => {
    console.log('Agent action:', actionId, event);
  },
});

// Generate UI from prompt
await genui.generate('Create a login form');

// Render to container
const cleanup = genui.render(document.getElementById('app')!);

// Get component manifest
const manifest = genui.getManifest();
```

### useAgentUI

Hook for real-time WebSocket-based agent communication:

```typescript
import { useAgentUI } from '@philjs/genui';

const agent = useAgentUI({
  endpoint: 'wss://api.example.com/agent',
  autoReconnect: true,
  reconnectInterval: 5000,
  onConnect: () => console.log('Connected'),
  onMessage: (message) => console.log('Received:', message),
  onError: (error) => console.error('Error:', error),
});

// Connect to agent
await agent.connect();

// Send message
agent.send('Show me the user dashboard', { userId: '123' });

// Access state
console.log('Connected:', agent.connected);
console.log('Session:', agent.sessionId);
console.log('Current UI:', agent.ui);

// Disconnect
agent.disconnect();
```

## Validation

Validate messages and components:

```typescript
import { validateMessage, validateComponent, validateLayout, schemas } from '@philjs/genui';

// Validate complete message
const messageResult = validateMessage(message);
if (!messageResult.valid) {
  console.error(messageResult.errors);
}

// Validate single component
const componentResult = validateComponent({
  id: 'btn-1',
  type: 'Button',
  props: { children: 'Click' },
});

// Validate layout
const layoutResult = validateLayout({
  type: 'grid',
  columns: '1fr 1fr',
});

// Access Zod schemas directly
const parsed = schemas.component.safeParse(componentData);
```

## Built-in Components

The package includes pre-registered components:

### Layout
- `Box` - Generic container
- `Stack` - Flex container (vertical/horizontal)
- `Grid` - CSS grid container

### Display
- `Text` - Text content
- `Heading` - Headings (h1-h6)

### Input
- `Button` - Interactive button
- `Input` - Text input field

### Feedback
- `Alert` - Alert/notification
- `Spinner` - Loading indicator

## TypeScript Support

Full type exports:

```typescript
import type {
  // Protocol types
  A2UIMessage,
  A2UIComponent,
  A2UILayout,
  A2UIBinding,
  A2UIAction,
  A2UIAnimation,

  // Registry types
  ComponentCapability,
  ComponentRenderer,
  RenderContext,
  ComponentManifest,

  // Sandbox types
  SandboxConfig,
  ValidationError,

  // Runtime types
  HydrationResult,
  HydratorOptions,

  // Hook types
  GenUIState,
  GenUIAgent,
  AgentUIState,
} from '@philjs/genui';
```

## Subpath Exports

```typescript
// Protocol only
import { createRenderMessage, validateMessage } from '@philjs/genui/protocol';

// Registry only
import { ComponentRegistry, registerBuiltins } from '@philjs/genui/registry';

// Runtime only
import { GenUIHydrator, createHydrator } from '@philjs/genui/runtime';

// Sandbox only
import { ASTValidator, DEFAULT_SANDBOX_CONFIG } from '@philjs/genui/sandbox';

// Hooks only
import { useGenUI, useAgentUI } from '@philjs/genui/hooks';
```

## License

MIT
