# Worklog 15: CI/CD Pipeline Setup

## Agent: Agent 15
## Task: Add automated validation to CI/CD
## Date: 2025-12-16

## Context

Previously, there was no comprehensive CI pipeline to prevent regression of issues being fixed. While a basic CI workflow existed, it lacked critical validations like path checking and cross-platform testing.

## Changes Made

### 1. Enhanced CI Workflow (`.github/workflows/ci.yml`)

The CI pipeline has been restructured into multiple specialized jobs for better organization and parallel execution:

#### Job: `validate-paths`
- **Purpose**: Prevents hardcoded absolute paths from being committed
- **Checks**:
  - Scans all `vite.config.*` files in examples for hardcoded paths (`/Users/`, `C:\\Users\\`, `/home/`)
  - Fails the build if hardcoded paths are found in config files
  - Warns (but doesn't fail) if hardcoded paths are found in source files
- **Runs on**: Ubuntu (fastest for grep operations)
- **Why it matters**: Prevents cross-platform issues caused by developer-specific absolute paths

#### Job: `lint-and-typecheck`
- **Purpose**: Fast feedback on code quality
- **Runs**:
  - `pnpm lint` - ESLint checks across all packages
  - `pnpm typecheck` - TypeScript validation across monorepo
- **Runs on**: Ubuntu
- **Node version**: 20 (updated from 18)
- **Runs in parallel with**: `validate-paths`

#### Job: `build-and-test`
- **Purpose**: Main validation - ensures code builds and tests pass
- **Depends on**: `validate-paths`, `lint-and-typecheck`
- **Runs**:
  - `pnpm test` - All unit tests across packages
  - `pnpm build` - Build all packages and examples
  - `pnpm check:budgets` - Performance budget validation
- **Runs on**: Ubuntu

#### Job: `e2e-tests`
- **Purpose**: End-to-end testing with Playwright
- **Depends on**: `build-and-test`
- **Runs**:
  - Installs Playwright browsers with dependencies
  - Runs E2E tests for storefront example
- **Runs on**: Ubuntu

#### Job: `cross-platform`
- **Purpose**: Ensures code works on Windows and macOS
- **Depends on**: `validate-paths`
- **Strategy**: Matrix testing across `windows-latest` and `macos-latest`
- **Runs**:
  - `pnpm typecheck` - Ensures types work cross-platform
  - `pnpm build` - Ensures build works on all platforms
  - `pnpm test` - Ensures tests pass on all platforms
- **fail-fast**: false (continues testing other platforms if one fails)

### 2. CI Configuration Details

**Triggers**:
- Push to `main` branch
- All pull requests

**Node.js Version**: 20 (LTS)
**pnpm Version**: 9 (matches `packageManager` in root `package.json`)

**Dependency Installation**: `pnpm install --no-frozen-lockfile`
- Allows flexibility during development
- Ensures latest compatible versions are used

### 3. Path Validation Implementation

The path validation check uses grep to search for common hardcoded path patterns:

```bash
grep -r "/Users/\|C:\\\\Users\\\\\|/home/" examples/*/vite.config.*
```

**Patterns detected**:
- `/Users/` - macOS user directories
- `C:\\Users\\` - Windows user directories (escaped for regex)
- `/home/` - Linux user directories

**Error behavior**:
- Config files: FAIL the build (critical)
- Source files: WARN only (may have legitimate uses)

**Best practices enforced**:
- Use `__dirname` for Node.js paths
- Use `import.meta.url` for ES modules
- Use relative paths like `../../packages/`
- Use `resolve()` with relative paths

## Benefits

1. **Prevents Regressions**: All critical checks run on every commit
2. **Fast Feedback**: Parallel jobs provide quick results
3. **Cross-Platform Safety**: Tests on Ubuntu, Windows, and macOS
4. **Path Validation**: Automatically catches hardcoded paths before merge
5. **Organized Jobs**: Clear separation of concerns makes failures easier to debug
6. **Performance Monitoring**: Budget checks ensure bundle sizes stay reasonable

## Job Dependency Graph

```
validate-paths ──┬──> lint-and-typecheck ──┐
                 │                          ├──> build-and-test ──> e2e-tests
                 └──> cross-platform        │
                      (Windows, macOS)      │
```

## CI Run Time Optimization

Jobs run in parallel where possible:
- `validate-paths` (fast, no deps needed)
- `lint-and-typecheck` (runs after validate-paths)
- `cross-platform` (runs after validate-paths)

Then sequentially:
- `build-and-test` waits for validation
- `e2e-tests` waits for build

## Testing the CI Pipeline

To test locally before pushing:

```bash
# Validate paths manually
grep -r "/Users/\|C:\\Users\\\|/home/" examples/*/vite.config.*

# Run all checks
pnpm lint
pnpm typecheck
pnpm test
pnpm build
pnpm check:budgets

# Run E2E tests
pnpm --filter examples/storefront test:e2e
```

## Future Enhancements

Potential improvements for future iterations:

1. **Caching**: Add build artifact caching to speed up cross-platform jobs
2. **Code Coverage**: Add coverage reporting and upload to Codecov
3. **Security Scanning**: Add dependency vulnerability scanning
4. **Release Automation**: Integrate with Changesets for automated releases
5. **Performance Tracking**: Track and trend performance budgets over time
6. **Docker Testing**: Add Docker-based testing for consistent environments
7. **Docs Deployment**: Add automatic deployment of documentation site

## Related Files

- `.github/workflows/ci.yml` - Main CI pipeline configuration
- `package.json` - Root scripts that CI executes
- `scripts/check-budgets.mjs` - Performance budget validation
- `examples/storefront/` - E2E test location

## Acceptance Criteria Met

- CI runs typecheck, build, test
- CI includes path validation that fails on hardcoded paths
- CI runs on Ubuntu, Windows, and macOS
- CI triggers on push to main and all pull requests
- CI configuration is documented in this worklog
- All jobs properly organized and dependent on each other

## Notes

- Node version upgraded from 18 to 20 for latest LTS
- pnpm version kept at 9 to match package.json
- Cross-platform tests run typecheck, build, and test (skips E2E for speed)
- Path validation runs first to fail fast on common mistakes
